{% extends "base.html" %}

{% block title %}Créer Matière - UIR Presence{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 py-12 px-4 sm:px-6 lg:px-8">
    <div class="max-w-3xl mx-auto">
        <div class="bg-white rounded-2xl shadow-xl overflow-hidden">
            <div class="bg-gradient-to-r from-primary to-secondary p-6">
                <h2 class="text-2xl font-bold text-white">Créer une Nouvelle Matière</h2>
                <p class="text-white opacity-90">Choisissez la filière et définissez les quotas horaires</p>
            </div>

            <div class="p-8">
                {% with messages = get_flashed_messages() %}
                {% if messages %}
                {% for message in messages %}
                <div class="mb-4 p-4 bg-yellow-50 border-l-4 border-yellow-500 text-yellow-700 rounded">
                    <p class="font-medium">{{ message }}</p>
                </div>
                {% endfor %}
                {% endif %}
                {% endwith %}

                <form method="POST" class="space-y-6">
                    <!-- Sélection Département (pour aide visuelle) -->
                    <div>
                        <label for="department_filter" class="block text-sm font-bold text-gray-700 mb-2">
                            Département (filtre visuel)
                        </label>
                        <select id="department_filter" onchange="filterTracks()"
                            class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-accent focus:ring-2 focus:ring-accent focus:outline-none transition-all">
                            <option value="">-- Tous les départements --</option>
                            {% extends "base.html" %}

                            {% block title %}Créer Matière - UIR Presence{% endblock %}

                            {% block content %}
                            <div class="min-h-screen bg-gray-50 py-12 px-4 sm:px-6 lg:px-8">
                                <div class="max-w-3xl mx-auto">
                                    <div class="bg-white rounded-2xl shadow-xl overflow-hidden">
                                        <div class="bg-gradient-to-r from-primary to-secondary p-6">
                                            <h2 class="text-2xl font-bold text-white">Créer une Nouvelle Matière</h2>
                                            <p class="text-white opacity-90">Choisissez la filière et définissez les
                                                quotas horaires</p>
                                        </div>

                                        <div class="p-8">
                                            {% with messages = get_flashed_messages() %}
                                            {% if messages %}
                                            {% for message in messages %}
                                            <div
                                                class="mb-4 p-4 bg-yellow-50 border-l-4 border-yellow-500 text-yellow-700 rounded">
                                                <p class="font-medium">{{ message }}</p>
                                            </div>
                                            {% endfor %}
                                            {% endif %}
                                            {% endwith %}

                                            <form method="POST" class="space-y-6">
                                                <!-- Sélection Département (pour aide visuelle) -->
                                                <div>
                                                    <label for="department_filter"
                                                        class="block text-sm font-bold text-gray-700 mb-2">
                                                        Département (filtre visuel)
                                                    </label>
                                                    <select id="department_filter" onchange="filterTracks()"
                                                        class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-accent focus:ring-2 focus:ring-accent focus:outline-none transition-all">
                                                        <option value="">-- Tous les départements --</option>
                                                        {% for dept in departments %}
                                                        <option value="{{ dept.id }}">{{ dept.name }}</option>
                                                        {% endfor %}
                                                    </select>
                                                </div>

                                                <!-- Sélection Filière -->
                                                <div>
                                                    <label for="track_id"
                                                        class="block text-sm font-bold text-gray-700 mb-2">
                                                        Filière <span class="text-red-500">*</span>
                                                    </label>
                                                    <select id="track_id" name="track_id" required
                                                        onchange="filterSemesters()"
                                                        class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-accent focus:ring-2 focus:ring-accent focus:outline-none transition-all">
                                                        <option value="">-- Sélectionnez une filière --</option>
                                                        {% for track in tracks %}
                                                        <option value="{{ track.id }}"
                                                            data-department="{{ track.department_id }}">
                                                            {{ track.department.name }} - {{ track.name }}
                                                        </option>
                                                        {% endfor %}
                                                    </select>
                                                </div>

                                                <!-- Nom de la matière -->
                                                <div>
                                                    <label for="name"
                                                        class="block text-sm font-bold text-gray-700 mb-2">
                                                        Nom de la Matière <span class="text-red-500">*</span>
                                                        filterSemesters(); // Re-filter semesters
                                                        }
                                                        }

                                                        // Filtrer les semestres par année académique ET filière
                                                        function filterSemesters() {
                                                        const yearId =
                                                        document.getElementById('academic_year_id').value;
                                                        const trackId = document.getElementById('track_id').value;
                                                        const semesterSelect = document.getElementById('semester_id');
                                                        const options = semesterSelect.querySelectorAll('option');

                                                        if (!yearId || !trackId) {
                                                        semesterSelect.disabled = true;
                                                        semesterSelect.value = '';
                                                        options[0].textContent = '-- Sélectionnez d\'abord une année et
                                                        une filière --';
                                                        return;
                                                        }

                                                        semesterSelect.disabled = false;
                                                        options[0].textContent = '-- Sélectionnez un semestre --';
                                                        options[0].style.display = 'block';

                                                        let hasVisibleOptions = false;
                                                        options.forEach(option => {
                                                        if (option.value === '') {
                                                        return;
                                                        }

                                                        const optionYear = option.getAttribute('data-year');
                                                        const optionTrack = option.getAttribute('data-track');

                                                        // Show semester if:
                                                        // 1. It belongs to the selected academic year
                                                        // AND
                                                        // 2. It is either a "common" semester OR matches the selected
                                                        track
                                                        const matchesYear = (optionYear === yearId);
                                                        const matchesTrack = (optionTrack === 'common' || (trackId &&
                                                        optionTrack === trackId));

                                                        if (matchesYear && matchesTrack) {
                                                        option.style.display = 'block';
                                                        hasVisibleOptions = true;
                                                        } else {
                                                        option.style.display = 'none';
                                                        }
                                                        });

                                                        // Reset selection if current selection is invalid
                                                        if (semesterSelect.selectedOptions[0] &&
                                                        semesterSelect.selectedOptions[0].style.display === 'none') {
                                                        semesterSelect.value = '';
                                                        }

                                                        if (!hasVisibleOptions) {
                                                        options[0].textContent = '-- Aucun semestre disponible pour
                                                        cette configuration --';
                                                        }
                                                        }
                                                        </script>
                                                        {% endblock %}